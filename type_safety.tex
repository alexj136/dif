\section{Type safety of DIF}

\begin{LEMMA}[Preservation of subtyping under type translation]
    \label{pres_subtyping}
    If $\SJ{\Gamma}{S}{U}$ then $\SJT{\TRANS{\Gamma}}{\TRANS{S}}{\TRANS{U}}$.
\end{LEMMA}

\begin{proof}
    By induction on subtyping derivations.
    \begin{itemize}
        \item \textbf{Case} \RULE{Top}: $\SJ{\Gamma}{S}{\top}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Bot}: $\SJ{\Gamma}{\bot}{S}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Refl}: $\SJ{\Gamma}{S}{S}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Trans}: $\SJ{\Gamma}{S}{R}$
        \begin{itemize}
            \item By inversion of \RULE{Trans}:
            \begin{itemize}
                \item $\SJ{\Gamma}{S}{U}$
                \item $\SJ{\Gamma}{U}{R}$
            \end{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{<:-And}: $\SJ{\Gamma}{S}{\AGG{U}{R}}$
        \begin{itemize}
            \item By inversion of \RULE{<:-And}:
            \begin{itemize}
                \item $\SJ{\Gamma}{S}{U}$
                \item $\SJ{\Gamma}{S}{R}$
            \end{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{<:-Sel}: $\SJ{\Gamma}{S}{x.A}$
        \begin{itemize}
            \item By inversion of \RULE{<:-Sel}:
                $\TJT{\Gamma}{x}{\TDEC{A}{S}{U}}$
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Sel-<:}: $\SJ{\Gamma}{x.A}{U}$
        \begin{itemize}
            \item By inversion of \RULE{Sel-<:}:
                $\TJT{\Gamma}{x}{\TDEC{A}{S}{U}}$
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{All-<:-All-Ex}:
            $\SJ{\Gamma}{\DFUN{x}{S_1}{U_1}}{\DFUN{x}{S_2}{U_2}}$
        \begin{itemize}
            \item By inversion of \RULE{All-<:-All-Ex}:
            \begin{itemize}
                \item $\SJ{\Gamma}{S_2}{S_1}$
                \item $\SJ{\Gamma, x: S_2}{U_1}{U_2}$
            \end{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Typ-<:-Typ}:
            $\SJ{\Gamma}{\TDEC{A}{S_1}{U_1}}{\TDEC{A}{S_2}{U_2}}$
        \begin{itemize}
            \item By inversion of \RULE{Typ-<:-Typ}:
            \begin{itemize}
                \item $\SJ{\Gamma}{S_2}{S_1}$
                \item $\SJ{\Gamma}{U_1}{U_2}$
            \end{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{And$_1$-<:}: $\SJ{\Gamma}{\AGG{S}{U}}{S}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{And$_2$-<:}: $\SJ{\Gamma}{\AGG{S}{U}}{U}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Fld-<:-Fld}:
            $\SJ{\Gamma}{\FDEC{a}{S}}{\FDEC{a}{U}}$
        \begin{itemize}
            \item By inversion of \RULE{Fld-<:-Fld}: $\SJ{\Gamma}{S}{U}$
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{All-<:-All-Im}:
            $\SJ{\Gamma}{\IFUN{x}{S_1}{U_1}}{\IFUN{x}{S_2}{U_2}}$
        \begin{itemize}
            \item By inversion of \RULE{All-<:-All-Im}:
            \begin{itemize}
                \item $\SJ{\Gamma}{S_2}{S_1}$
                \item $\SJ{\Gamma, x: S_2}{U_1}{U_2}$
            \end{itemize}
            \item \TODOTHIS
        \end{itemize}
    \end{itemize}
\end{proof}

\begin{LEMMA}[Preservation of free variables under type translation]
    \label{pres_fv}
    For all $S$, $\FV{S} = \FV{\TRANS{S}}$.
\end{LEMMA}

\begin{proof}
    Immediate from definition \ref{translation}.
\end{proof}

\begin{LEMMA}[Commutativity of type translation and name substitution]
    \label{comm_trans_sub}
    For all $S$, $u$, $v$, $\SUB{u}{v}(\TRANS{S}) = \TRANS{(\SUB{u}{v}S)}$.
\end{LEMMA}

\begin{proof}
    \TODOTHIS
\end{proof}

\begin{THEOREM}[Type-preserving translation of DIF terms]
    \label{tp_terms}
    If $\TJ{\Gamma}{t}{S}{\HAT{t}}$ then
    $\TJT{\TRANS{\Gamma}}{\HAT{t}}{\TRANS{S}}$.
\end{THEOREM}

\begin{proof}
    By induction on typing derivations.
    \begin{itemize}
        \item \textbf{Case} \RULE{Var-Ex}: $\TJ{\Gamma, p: S, \Gamma'}{p}{S}{p}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{(\Gamma, p: S, \Gamma')}}{p}{\TRANS{S}}$
            \begin{itemize}
                \item Or by definition \ref{translation}, 
                    $\TJT{\TRANS{\Gamma}, p: \TRANS{S},
                    \TRANS{\Gamma'}}{p}{\TRANS{S}}$
            \end{itemize}
            \item The goal follows immediately from \RULET{Var}.
        \end{itemize}
        \item \textbf{Case} \RULE{Var-Im}:
            $\TJ{\Gamma, i: S, \Gamma'}{\IMP}{S}{i}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{(\Gamma, i: S, \Gamma')}}{i}{\TRANS{S}}$
            \begin{itemize}
                \item Or by definition \ref{translation}, 
                    $\TJT{\TRANS{\Gamma}, i: \TRANS{S},
                    \TRANS{\Gamma'}}{i}{\TRANS{S}}$
            \end{itemize}
            \item The goal follows immediately from \RULET{Var}.
        \end{itemize}
        \item \textbf{Case} \RULE{Sub}: $\TJ{\Gamma}{t}{S'}{\HAT{t}}$
        \begin{itemize}
            \item By inversion of \RULE{Sub}:
            \begin{itemize}
                \item $\TJ{\Gamma}{t}{S}{\HAT{t}}$
                \begin{itemize}
                    \item And by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{t}}{\TRANS{S}}$
                \end{itemize}
                \item $\SJ{\Gamma}{S}{S'}$
                \begin{itemize}
                    \item And by lemma \ref{pres_subtyping}:
                        $\SJT{\TRANS{\Gamma}}{\TRANS{S}}{\TRANS{S'}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{Sub}.
        \end{itemize}
        \item \textbf{Case} \RULE{All-Ex-I}: $\TJ{\Gamma}{\ABS{x}{S}{t}}
            {\DFUN{u}{S}{U}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{\Gamma}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}
                {\TRANS{(\DFUN{u}{S}{U})}}$
            \begin{itemize}
                \item Or by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}
                    {\DFUN{u}{\TRANS{S}}{\TRANS{U}}}$
            \end{itemize}
            \item By inversion of \RULE{All-Ex-I}:
            \begin{itemize}
                \item $x \leadsto u$
                \begin{itemize}
                    \item Then either $x = u$ or $u\ \text{fresh}$
                \end{itemize}
                \item $\TJ{\Gamma, u: S}{t}{U}{\HAT{t}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{(\Gamma, u: S)}}{\HAT{t}}\TRANS{{U}}$
                    \item And by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}, u: \TRANS{S}}{\HAT{t}}\TRANS{{U}}$
                \end{itemize}
                \item $\{x, u\} \cap \FV{S} = \o$
                \begin{itemize}
                    \item Then by lemma \ref{pres_fv},
                        $\{x, u\} \cap \FV{\TRANS{S}} = \o$, and then $u \notin
                        \FV{\TRANS{S}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{All-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{All-Ex-E}:
            $\TJ{\Gamma}{x\ y}{\SUB{u}{y}U}{\HAT{x}\ \HAT{y}}$
        \begin{itemize}
            \item To show:
                $\TJT{\TRANS{\Gamma}}{\HAT{x}\ \HAT{y}}{\TRANS{(\SUB{u}{y}U)}}$
            \begin{itemize}
                \item Or by lemma \ref{comm_trans_sub}: $\TJT{\TRANS{\Gamma}}
                    {\HAT{x}\ \HAT{y}}{\SUB{u}{y}\TRANS{U}}$
            \end{itemize}
            \item By inversion of \RULE{All-Ex-E}:
            \begin{itemize}
                \item $\TJ{\Gamma}{x}{\DFUN{u}{S}{U}}{\HAT{x}}$
                \begin{itemize}
                    \item Then by induction: $\TJT{\TRANS{\Gamma}}
                        {\HAT{x}}{\TRANS{(\DFUN{u}{S}{U})}}$
                    \item Then by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}}{\HAT{x}}
                        {\DFUN{u}{\TRANS{S}}{\TRANS{U}}}$
                \end{itemize}
                \item $\TJ{\Gamma}{y}{S}{\HAT{y}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{y}}{\TRANS{S}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{All-E}.
        \end{itemize}
        \item \textbf{Case} \RULE{Let}:
            $\TJ{\Gamma}{\LET{x}{t}{t'}}{U}{\LET{u}{\HAT{t}}{\HAT{t'}}}$
        \begin{itemize}
            \item To show:
                $\TJT{\TRANS{\Gamma}}{\LET{u}{\HAT{t}}{\HAT{t'}}}{\TRANS{U}}$
            \item By inversion of \RULE{LET}:
            \begin{itemize}
                \item $x \leadsto u$
                \item $\TJ{\Gamma}{t}{S}{\HAT{t}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{t}}{\TRANS{S}}$
                \end{itemize}
                \item $\TJ{\Gamma, u: S}{t'}{U}{\HAT{t'}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{(\Gamma, u: S)}}{\HAT{t'}}{\TRANS{U}}$
                    \item Then by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}, u: \TRANS{S}}
                        {\HAT{t'}}{\TRANS{U}}$
                \end{itemize}
                \item $x \notin \FV{U}$
                \begin{itemize}
                    \item Then by lemma \ref{pres_fv}: $x \notin \FV{\TRANS{U}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{Let}.
        \end{itemize}
        \item \textbf{Case} \RULE{And-I}: $\TJ{\Gamma}{x}{\AGG{S}{U}}{\HAT{x}}$
        \begin{itemize}
            \item To show:
                $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{(\AGG{S}{U})}}$
            \begin{itemize}
                \item Or by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\AGG{\TRANS{S}}{\TRANS{U}}}$
            \end{itemize}
            \item By inversion of \RULE{And-I}:
            \begin{itemize}
                \item $\TJ{\Gamma}{x}{S}{\HAT{x}}$
                \begin{itemize}
                    \item Then by induction: 
                        $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{S}}$
                \end{itemize}
                \item $\TJ{\Gamma}{x}{U}{\HAT{x}}$
                \begin{itemize}
                    \item Then by induction: 
                        $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{U}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{And-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{\{\}-I}: $\TJ{\Gamma}
            {\OBJ{x}{S}{d}}{\REC{u}{S}}{\OBJ{u}{\TRANS{S}}{\HAT{d}}}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{\Gamma}}{\OBJ{u}{\TRANS{S}}{\HAT{d}}}
                {\TRANS{(\REC{u}{S})}}$
            \begin{itemize}
                \item Or by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\OBJ{u}{\TRANS{S}}{\HAT{d}}}
                    {\REC{u}{\TRANS{S}}}$
            \end{itemize}
            \item By inversion of \RULE{\{\}-I}:
            \begin{itemize}
                \item $x \leadsto u$
                \item $\TJ{\Gamma, u: S}{d}{S}{\HAT{d}}$
                \begin{itemize}
                    \item Then by theorem \ref{tp_defs}:
                        $\TJT{\TRANS{(\Gamma, u: S)}}{\HAT{d}}{\TRANS{S}}$
                    \item And by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}, u: \TRANS{S}}{\HAT{d}}{\TRANS{S}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{\{\}-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{Fld-E}: $\TJ{\Gamma}{x.a}{S}{\HAT{x}.a}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{\Gamma}}{\HAT{x}.a}{\TRANS{S}}$
            \item By inversion of \RULE{Fld-E}:
                $\TJ{\Gamma}{x}{\FDEC{a}{S}}{\HAT{x}}$
            \begin{itemize}
                \item Then by induction:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{\FDEC{a}{S}}}$
                \item And by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\FDEC{a}{\TRANS{S}}}$
            \end{itemize}
            \item The goal then follows from \RULET{Fld-E}.
        \end{itemize}
        \item \textbf{Case} \RULE{Rec-I}:
            $\TJ{\Gamma}{x}{\REC{\HAT{x}}{S}}{\HAT{x}}$
        \begin{itemize}
            \item To show:
                $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{\REC{\HAT{x}}{S}}}$
            \begin{itemize}
                \item Or by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\REC{\HAT{x}}{\TRANS{S}}}$
            \end{itemize}
            \item By inversion of \RULE{Rec-I}: $\TJ{\Gamma}{x}{S}{\HAT{x}}$
            \begin{itemize}
                \item Then by induction:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{S}}$
            \end{itemize}
            \item The goal then follows from \RULET{Rec-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{Rec-E}: $\TJ{\Gamma}{x}{S}{\HAT{x}}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{S}}$
            \item By inversion of \RULE{Rec-E}:
                $\TJ{\Gamma}{x}{\REC{\HAT{x}}{S}}{\HAT{x}}$
            \begin{itemize}
                \item Then by induction:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{\REC{\HAT{x}}{S}}}$
                \item And by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\REC{\HAT{x}}{\TRANS{S}}}$
            \end{itemize}
            \item The goal then follows from \RULET{Rec-E}.
        \end{itemize}
        \item \textbf{Case} \RULE{All-Im-I}:
            $\TJ{\Gamma}{t}{\IFUN{u}{S}{U}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{\Gamma}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}
                {\TRANS{(\IFUN{u}{S}{U})}}$
            \begin{itemize}
                \item Or by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}
                    {\IFUN{u}{\TRANS{S}}{\TRANS{U}}}$
            \end{itemize}
            \item By inversion of \RULE{All-Im-I}:
            \begin{itemize}
                \item $u\ \text{fresh}$
                \item $\TJ{\Gamma, u: S}{t}{U}{\HAT{t}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{(\Gamma, u: S)}}{\HAT{t}}{\TRANS{U}}$
                    \item And by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}, u: \TRANS{S}}{\HAT{t}}{\TRANS{U}}$
                \end{itemize}
                \item $u \notin \FV{S}$
                \begin{itemize}
                    \item Then by lemma \ref{pres_fv}: $u \notin \FV{\TRANS{S}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{All-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{All-Im-E}:
            $\TJ{\Gamma}{x}{\SUB{u}{v}U}{\HAT{x}\ v}$
        \begin{itemize}
            \item To show:
                $\TJT{\TRANS{\Gamma}}{\HAT{x}\ v}{\TRANS{(\SUB{u}{v}U)}}$
            \begin{itemize}
                \item Or by lemma \ref{comm_trans_sub}:
                    $\TJT{\TRANS{\Gamma}}{\HAT{x}\ v}{\SUB{u}{v}\TRANS{U}}$
            \end{itemize}
            \item By inversion of \RULE{All-Im-E}:
            \begin{itemize}
                \item $\TJ{\Gamma}{x}{\IFUN{u}{S}{U}}{\HAT{x}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{x}}{\TRANS{(\IFUN{u}{S}{U})}}$
                    \item And by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}}
                        {\HAT{x}}{\DFUN{u}{\TRANS{S}}{\TRANS{U}}}$
                \end{itemize}
                \item $\TJ{\Gamma}{\IMP}{S}{v}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{\Gamma}}{v}{\TRANS{S}}$
                \end{itemize}
            \end{itemize}
        \item The goal then follows from \RULET{All-E}.
        \end{itemize}
    \end{itemize}
\end{proof}

\begin{THEOREM}[Type and domain-preserving translation of DIF definitions]
    \label{tp_defs}
    If $\TJ{\Gamma}{d}{S}{\HAT{d}}$ then
    $\TJT{\TRANS{\Gamma}}{\HAT{d}}{\TRANS{S}}$ and $\DOM{d} =
    \DOM{\HAT{d}}$.
\end{THEOREM}

\begin{proof}
    By induction on typing derivations.
    \begin{itemize}
        \item \textbf{Case} \RULE{Typ-I}:
            $\TJ{\Gamma}{\DEF{A}{S}}{\TDEC{A}{S}{S}}{\DEF{A}{\TRANS{S}}}$
        \begin{itemize}
            \item To show for type preservation: $\TJT{\TRANS{\Gamma}}
                {\DEF{A}{\TRANS{S}}}{\TRANS{(\TDEC{A}{S}{S})}}$
            \begin{itemize}
                \item Or by definition \ref{translation}: $\TJT{\TRANS{\Gamma}}
                    {\DEF{A}{\TRANS{S}}}{\TDEC{A}{\TRANS{S}}{\TRANS{S}}}$
            \end{itemize}
            \item The goal for type preservation follows immediately from
                \RULET{Typ-I}.
            \item Domain preservation is immediate from \RULE{Typ-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{Fld-I}:
            $\TJ{\Gamma}{\DEF{a}{t}}{\FDEC{a}{S}}{\DEF{a}{\HAT{t}}}$
        \begin{itemize}
            \item To show for type preservation:
                $\TJT{\TRANS{\Gamma}}{\DEF{a}{\HAT{t}}}{\TRANS{\FDEC{a}{S}}}$
            \begin{itemize}
                \item Or by definition \ref{translation}: $\TJT{\TRANS{\Gamma}}
                    {\DEF{a}{\HAT{t}}}{\FDEC{a}{\TRANS{S}}}$
            \end{itemize}
            \item By inversion of \RULE{Fld-I}: $\TJ{\Gamma}{t}{S}{\HAT{t}}$
            \begin{itemize}
                \item Then by theorem \ref{tp_terms}:
                    $\TJT{\TRANS{\Gamma}}{\HAT{t}}{\TRANS{S}}$
            \end{itemize}
            \item The goal for type preservation then follows from
                \RULET{Fld-I}.
            \item Domain preservation is immediate from \RULE{Fld-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{AndDef-I}: $\TJ{\Gamma}
            {\AGG{d_1}{d_2}}{\AGG{S_1}{S_2}}{\AGG{\HAT{d_1}}{\HAT{d_2}}}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{\Gamma}}
                {\AGG{\HAT{d_1}}{\HAT{d_2}}}{\TRANS{(\AGG{S_1}{S_2})}}$
            \begin{itemize}
                \item Or by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\AGG{\HAT{d_1}}{\HAT{d_2}}}
                    {\AGG{\TRANS{S_1}}{\TRANS{S_2}}}$
            \end{itemize}
            \item By inversion of \RULE{AndDef-I}:
            \begin{itemize}
                \item $\TJ{\Gamma}{d_1}{S_1}{\HAT{d_1}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{d_1}}{\TRANS{S_1}}$ and
                        $\DOM{d_1} = \DOM{\HAT{d_1}}$
                \end{itemize}
                \item $\TJ{\Gamma}{d_2}{S_2}{\HAT{d_2}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{d_2}}{\TRANS{S_2}}$ and
                        $\DOM{d_2} = \DOM{\HAT{d_2}}$
                \end{itemize}
                \item $\DOM{d_1} \cap \DOM{d_2} = \o$
                \begin{itemize}
                    \item Then $\DOM{\HAT{d_1}} \cap \DOM{\HAT{d_2}} = \o$
                        follows since $\DOM{d_1} = \DOM{\HAT{d_1}}$ and
                        $\DOM{d_2} = \DOM{\HAT{d_2}}$
                \end{itemize}
            \end{itemize}
            \item The goal for type preservation then follows from
                \RULE{AndDef-I}.
            \item Domain preservation holds by induction: if $\DOM{d_1} =
                \DOM{\HAT{d_1}}$ and $\DOM{d_2} = \DOM{\HAT{d_2}}$ then it
                follows that $\DOM{\AGG{d_1}{d_2}} =
                \DOM{\AGG{\HAT{d_1}}{\HAT{d_2}}}$.
        \end{itemize}
    \end{itemize}
\end{proof}
