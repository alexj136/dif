\section{Type safety of DIF}

\subsection{Translation of Types}

\begin{DEFINITION}[Translation of types]
    \label{translation}
    Figure \ref{figure_translation} defines translation from DIF types to DOT
    types.
\end{DEFINITION}

\begin{figure}[h]
    \input{figure_translation}
    \caption{Translation from DIF types to DOT types}
    \label{figure_translation}
\end{figure}

We extend the definition of $\TRANS{(\bullet)}$ pointwise to environments
$\Gamma$.

\begin{LEMMA}[Preservation of subtyping under type translation]
    \label{pres_subtyping}
    If $\SJ{\Gamma}{S}{U}$ then $\SJT{\TRANS{\Gamma}}{\TRANS{S}}{\TRANS{U}}$.
\end{LEMMA}

\begin{proof}
    \TODOTHIS
\end{proof}

\begin{LEMMA}[Preservation of free variables under type translation]
    \label{pres_fv}
    For all $S$, $\FV{S} = \FV{\TRANS{S}}$.
\end{LEMMA}

\begin{proof}
    Directly from the definition.
\end{proof}

\begin{LEMMA}[Commutativity of type translation and name substitution]
    \label{comm_trans_sub}
    For all $S$, $u$, $v$, $\SUB{u}{v}(\TRANS{S}) = \TRANS{(\SUB{u}{v}S)}$.
\end{LEMMA}

\begin{proof}
    \TODOTHIS
\end{proof}

\begin{THEOREM}[Type-preserving translation of DIF terms]
    If $\TJ{\Gamma}{t}{S}{\HAT{t}}$ then
    $\TJT{\TRANS{\Gamma}}{\HAT{t}}{\TRANS{S}}$.
\end{THEOREM}

\begin{proof}
    By induction on typing derivations.
    \begin{itemize}
        \item \textbf{Case} \RULE{Var-Ex}: $\TJ{\Gamma, p: S, \Gamma'}{p}{S}{p}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{(\Gamma, p: S, \Gamma')}}{p}{\TRANS{S}}$
            \begin{itemize}
                \item Or by definition \ref{translation}, 
                    $\TJT{\TRANS{\Gamma}, p: \TRANS{S},
                    \TRANS{\Gamma'}}{p}{\TRANS{S}}$
            \end{itemize}
            \item The goal follows immediately from \RULET{Var}.
        \end{itemize}
        \item \textbf{Case} \RULE{Var-Im}:
            $\TJ{\Gamma, i: S, \Gamma'}{\IMP}{S}{i}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{(\Gamma, i: S, \Gamma')}}{i}{\TRANS{S}}$
            \begin{itemize}
                \item Or by definition \ref{translation}, 
                    $\TJT{\TRANS{\Gamma}, i: \TRANS{S},
                    \TRANS{\Gamma'}}{i}{\TRANS{S}}$
            \end{itemize}
            \item The goal follows immediately from \RULET{Var}.
        \end{itemize}
        \item \textbf{Case} \RULE{Sub}: $\TJ{\Gamma}{t}{S'}{\HAT{t}}$
        \begin{itemize}
            \item By inversion of \RULE{Sub}:
            \begin{itemize}
                \item $\TJ{\Gamma}{t}{S}{\HAT{t}}$
                \begin{itemize}
                    \item And by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{t}}{\TRANS{S}}$
                \end{itemize}
                \item $\SJ{\Gamma}{S}{S'}$
                \begin{itemize}
                    \item And by lemma \ref{pres_subtyping}:
                        $\SJT{\TRANS{\Gamma}}{\TRANS{S}}{\TRANS{S'}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{Sub}.
        \end{itemize}
        \item \textbf{Case} \RULE{All-Ex-I}: $\TJ{\Gamma}{\ABS{x}{S}{t}}
            {\DFUN{u}{S}{U}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}$
        \begin{itemize}
            \item To show: $\TJT{\TRANS{\Gamma}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}
                {\TRANS{(\DFUN{u}{S}{U})}}$
            \begin{itemize}
                \item Or by definition \ref{translation}:
                    $\TJT{\TRANS{\Gamma}}{\ABS{u}{\TRANS{S}}{\HAT{t}}}
                    {\DFUN{u}{\TRANS{S}}{\TRANS{U}}}$
            \end{itemize}
            \item By inversion of \RULE{All-Ex-I}:
            \begin{itemize}
                \item $x \leadsto u$
                \begin{itemize}
                    \item Then either $x = u$ or $u\ \text{fresh}$
                \end{itemize}
                \item $\TJ{\Gamma, u: S}{t}{U}{\HAT{t}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{(\Gamma, u: S)}}{\HAT{t}}\TRANS{{U}}$
                    \item And by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}, u: \TRANS{S}}{\HAT{t}}\TRANS{{U}}$
                \end{itemize}
                \item $\{x, u\} \cap \FV{S} = \o$
                \begin{itemize}
                    \item Then by lemma \ref{pres_fv},
                        $\{x, u\} \cap \FV{\TRANS{S}} = \o$, and then $u \notin
                        \FV{\TRANS{S}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{All-I}.
        \end{itemize}
        \item \textbf{Case} \RULE{All-Ex-E}:
            $\TJ{\Gamma}{x\ y}{\SUB{u}{y}U}{\HAT{x}\ \HAT{y}}$
        \begin{itemize}
            \item To show:
                $\TJT{\TRANS{\Gamma}}{\HAT{x}\ \HAT{y}}{\TRANS{(\SUB{u}{y}U)}}$
            \begin{itemize}
                \item Or by lemma \ref{comm_trans_sub}: $\TJT{\TRANS{\Gamma}}
                    {\HAT{x}\ \HAT{y}}{\SUB{u}{y}\TRANS{U}}$
            \end{itemize}
            \item By inversion of \RULE{All-Ex-E}:
            \begin{itemize}
                \item $\TJ{\Gamma}{x}{\DFUN{u}{S}{U}}{\HAT{x}}$
                \begin{itemize}
                    \item Then by induction: $\TJT{\TRANS{\Gamma}}
                        {\HAT{x}}{\TRANS{(\DFUN{u}{S}{U})}}$
                    \item Then by definition \ref{translation}:
                        $\TJT{\TRANS{\Gamma}}{\HAT{x}}
                        {\DFUN{u}{\TRANS{S}}{\TRANS{U}}}$
                \end{itemize}
                \item $\TJ{\Gamma}{y}{S}{\HAT{y}}$
                \begin{itemize}
                    \item Then by induction:
                        $\TJT{\TRANS{\Gamma}}{\HAT{y}}{\TRANS{S}}$
                \end{itemize}
            \end{itemize}
            \item The goal then follows from \RULET{All-E}.
        \end{itemize}
        \item \textbf{Case} \RULE{Let}:
            $\TJ{\Gamma}{\LET{x}{t}{t'}}{U}{\LET{u}{\HAT{t}}{\HAT{t'}}}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{And-I}: $\TJ{\Gamma}{x}{\AGG{S}{U}}{\HAT{x}}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{\{\}-I}:
            $\TJ{\Gamma}{\OBJ{x}{S}{d}}{\REC{u}{S}}{\OBJ{u}{S}{\HAT{d}}}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Fld-E}: $\TJ{\Gamma}{x.a}{S}{\HAT{x}.a}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Rec-I}: $\TJ{\Gamma}{x}{\REC{x}{S}}{\HAT{x}}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{Rec-E}: $\TJ{\Gamma}{x}{S}{\HAT{x}}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{All-Im-I}:
            $\TJ{\Gamma}{t}{\IFUN{u}{S}{U}}{\ABS{u}{S}{\HAT{t}}}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
        \item \textbf{Case} \RULE{All-Im-E}:
            $\TJ{\Gamma}{x}{\SUB{u}{v}U}{\HAT{x}\ v}$
        \begin{itemize}
            \item \TODOTHIS
        \end{itemize}
    \end{itemize}
\end{proof}
